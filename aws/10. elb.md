- <img width="827" alt="스크린샷 2023-04-16 오후 6 16 08" src="https://user-images.githubusercontent.com/62214428/232289046-7512f40f-c663-473d-ad34-d47b76d11204.png">
```
앞서 오토스케일링 그룹을 통해 다수의 인스턴스를 생성했다.
하지만. 현재는 유저 입장에서 서비스에 접근하기 위해선 인스턴스의 정보(ip)를 알아야접근할 수 있다.
또한 ec2가 재시동되면서 퍼블릭 ip도 변경될 수 있다.
따라서 유저가 접근할 수 있는 지점을 생성하고 그 뒷단은 알필요가없도록 해야한다.
```
### Elastic load balancer
- 여러 인스턴스에 부하를 분산해주며 사용자가 접근할 수 있는 단일 지점
- elb는 들어오는 애플리케이션 트래픽을 ec2,컨테이너와 같은 여러 대상에 자동으로 분산시킨다.
- `지속적으로 ip 주소가 바뀌며 ip 고정 불가능` : 항상 도메인 기반으로 사용해야한다.

```
NLB : network lb
- L4스위치로 ip기반 라우팅
- tcp 기반 빠른 트래픽 분산
- elastic IP 할당 가능: ip 고정 가능

ALB : application lb
- L7 스위치로 http !경로 기반! 라우팅
  - ex) image.com -> 이미지 서버로 / web.com -> 웹 서버로 경로 기반 라우팅
- 당연히 L4 영역 커버 가능 & 비용 더 비쌈
```

### Target group
- alb가 라우팅 할 대상의 집합
- 구성
  - instance
  - private ip
  - lambda
  - alb : 다른 alb랑도 연결할 수 있다.
  - 프로토콜 (http, https, gRPC)
- <img width="1261" alt="스크린샷 2023-04-16 오후 6 33 41" src="https://user-images.githubusercontent.com/62214428/232290003-5799cf94-3a7f-4458-852a-3a7b6f17d785.png">


### 로드밸런서 만들기 - 대상 그룹 만들기
- 이번에는 로드밸런서를 만들기전 누구한테 트래픽을 전달할지 대상이 되는 대상 그룹을 만든다
- 앞서 오토스케일링 그룹을 생성했다. 그리고 이렇게 생성된 인스턴스들에게 트래픽을 전달하기위해 두 인스턴스를 하나의 대상그룹으로 묶는다.
- <img width="1172" alt="스크린샷 2023-04-16 오후 10 21 21" src="https://user-images.githubusercontent.com/62214428/232314282-d0e8c195-68db-4753-af44-a3a3ecabed37.png">

### 로드밸런서 만들기
- <img width="1091" alt="스크린샷 2023-04-16 오후 10 24 01" src="https://user-images.githubusercontent.com/62214428/232314427-da3d23e5-41fe-4d77-a9f7-bd0209d7993c.png">
```
alb생성시 대상 그룹을 이전에 생성해둔 대상 그룹으로 설정한다.
```
- <img width="1244" alt="스크린샷 2023-04-16 오후 10 28 37" src="https://user-images.githubusercontent.com/62214428/232314688-49c61d7b-81b8-4473-bb65-d880b27257e7.png">
```
dns를 복사하여 들어가보면 설정해둔 대상 그룹에 속한 ec2중 하나로 라우팅해준다
```
- <img width="639" alt="스크린샷 2023-04-16 오후 10 29 29" src="https://user-images.githubusercontent.com/62214428/232314746-c19b040c-71d4-4fe6-b967-128255b7ae0c.png">

### 오토스케일링 그룹에 로드밸런서 설정하기
- 지금 이건 !현재! 오토스케일링으로 생성되어있는 ec2만 로드밸런싱의 타겟 그룹으로 지정한것
- 만약 오토스케일링을 통해 인스턴스가 새로 생성된다면 그 인스턴스는 로드밸런서의 타겟이 아니다.
- 따라서 오토스케일링 그룹에 로드밸런서로 현재 로드밸런서를 설정해준다.
- <img width="951" alt="스크린샷 2023-04-16 오후 10 35 17" src="https://user-images.githubusercontent.com/62214428/232315036-110cd0a1-6aab-450c-a200-ca3140e0e978.png">
```
테스트하기위해 오토스케일링 그룹 크기를 늘려서 새로운 인스턴스를 생성해보자

--
오토스케일링 그룹에 로드밸런서를 설정해줌으로써
오토스케일링으로 새롭게 생성된 인스턴스도 로드밸런서 타겟 그룹에 포함된다.
```
- <img width="319" alt="스크린샷 2023-04-16 오후 10 41 16" src="https://user-images.githubusercontent.com/62214428/232315336-871bcf52-9ed3-4445-ad50-3b3a26b8cd7b.png">

### 생각해보자
```
만약에 ec2는 정상 동작하지만 / 그 위에서 동작하는 웹서버만! 다운된다면?

오토스케일링 입장에선 ec2는 잘 동작하니까 - 정상
로드밸런서 입장에선 웹서버가 동작하지 않으니 트래픽을 보낼 수 없다 - 비정상
```
- 따라서 오토스케일링 그룹 설정 중 헬스체크 부분에서 ec2뿐만 아니라 elb 헬스체크도 On
- <img width="853" alt="스크린샷 2023-04-16 오후 10 47 40" src="https://user-images.githubusercontent.com/62214428/232315703-273318a1-078f-41b1-96aa-68190fe7b20d.png">
- 인스턴스 하나의 웹서버를 죽여보면
- <img width="920" alt="스크린샷 2023-04-16 오후 10 50 23" src="https://user-images.githubusercontent.com/62214428/232315812-cb14bfba-284f-4569-b405-9395622c1551.png">
```
오토스케일링 그룹이 elb가 알려준 unhealthy 상태를 가진 웹서버의 인스턴스를 재시동한다.
```
